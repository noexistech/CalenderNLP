<!doctype html>
<html lang="vi">
<head>
  <meta charset="utf-8">
  <title>Calendar NLP Assistant</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">

  <!-- Bootstrap -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
  <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.css" rel="stylesheet">

<style>
    body {
        background: #0f172a;
        color: #e2e8f0;
        font-family:
            system-ui,
            -apple-system,
            BlinkMacSystemFont,
            "Segoe UI",
            sans-serif;
    }

    .fw-semibold {
        color: white; /* Ho·∫∑c m√£ m√†u b·∫°n mu·ªën, v√≠ d·ª•: #007bff */
    }

    .text-secondary {
        color: #ffc107 !important; /* ƒê·ªïi th√†nh m√†u v√†ng warning */
    }

    .calendar-card,
    .sidebar-card {
        background: #020617;
        border-radius: 1rem;
        border: 1px solid rgba(148, 163, 184, 0.2);
        box-shadow: 0 20px 40px rgba(15, 23, 42, 0.9);
    }
    .calendar-header {
        border-bottom: 1px solid rgba(148, 163, 184, 0.25);
    }
    .calendar-grid {
        display: grid;
        grid-template-columns: repeat(7, 1fr);
        gap: 4px;
    }
    .day-cell {
        height: 110px;
        border: 1px solid rgba(30, 64, 175, 0.4);
        border-radius: 8px;
        padding: 4px;
        position: relative;
        overflow: hidden;
        background: rgba(15, 23, 42, 0.9);
        cursor: pointer;
        transition:
            background 0.1s ease,
            transform 0.05s ease;
    }
    .day-cell:hover {
        background: rgba(37, 99, 235, 0.25);
        transform: translateY(-1px);
    }
    .day-number {
        font-size: 0.85rem;
        font-weight: 600;
    }
    .day-today {
        border-color: #38bdf8;
        box-shadow: 0 0 0 1px rgba(56, 189, 248, 0.8);
    }
    .day-events {
        position: absolute;
        top: 25px;
        left: 4px;
        right: 4px;
        bottom: 4px;
        overflow-y: auto;
    }
    .day-events::-webkit-scrollbar {
        width: 0px;
    }
    .event-pill {
        display: block;
        width: 100%;
        white-space: nowrap;
        overflow: hidden;
        text-overflow: ellipsis;
        padding: 3px 8px;
        border-radius: 999px;
        font-size: 0.75rem;
        margin-bottom: 3px;
        color: #0b1120;
        font-weight: 500;
    }
    .badge-dot {
        display: inline-block;
        width: 8px;
        height: 8px;
        border-radius: 999px;
        margin-right: 4px;
    }
    .toast-container {
        position: fixed;
        top: 5rem;
        right: 1rem;
        z-index: 3000;
    }

    .toast {
        background-color: #020617;
        color: #e2e8f0;
        border-radius: 0.75rem;
        border: 1px solid rgba(148, 163, 184, 0.5);
        min-width: 360px; /* to h∆°n */
        max-width: 420px;
        font-size: 0.95rem; /* ch·ªØ to h∆°n ch√∫t */
    }

    .scroll-panel {
        max-height: 360px;
        overflow-y: auto;
    }

    /* ================================
   RESPONSIVE TUNING
================================ */

    /* Gi·∫£m chi·ªÅu cao √¥ l·ªãch tr√™n mobile */
    @media (max-width: 768px) {
        .day-cell {
            height: 80px;
            padding: 2px;
        }
        .day-number {
            font-size: 0.75rem;
        }
        .event-pill {
            font-size: 0.65rem;
            padding: 2px 6px;
        }
    }

    /* Table ƒë·∫ßu tu·∫ßn g·ªçn h∆°n tr√™n mobile */
    @media (max-width: 576px) {
        .table thead th {
            font-size: 0.65rem !important;
            padding: 2px !important;
        }
    }

    /* Calendar card full width + gi·∫£m padding */
    @media (max-width: 992px) {
        .calendar-card {
            margin-bottom: 1rem;
        }
    }

    /* Sidebar chuy·ªÉn xu·ªëng d∆∞·ªõi */
    @media (max-width: 992px) {
        .col-lg-4 {
            order: 2;
        }
        .col-lg-8 {
            order: 1;
        }
    }

    /* Header button group xu·ªëng h√†ng */
    @media (max-width: 768px) {
        .d-flex.flex-wrap.gap-2 button {
            flex: 1 1 48%;
            font-size: 0.8rem;
            padding: 6px;
        }
    }

    /* T·ªëi ∆∞u modal tr√™n mobile */
    @media (max-width: 576px) {
        .modal-content {
            border-radius: 0.5rem;
        }
        #eventModal textarea {
            font-size: 0.9rem;
        }
    }

    /* Sidebar scroll t·ªëi ∆∞u */
    @media (max-width: 768px) {
        .scroll-panel {
            max-height: 240px;
        }
    }

    /* Calendar grid tr√°nh overflow ngang */
    #calendarGrid {
        width: 100%;
        overflow: hidden;
    }

    /* Gi·∫£m b√≥ng ƒë·ªï cho mobile cho ƒë·ª° r·ªëi */
    @media (max-width: 576px) {
        .calendar-card,
        .sidebar-card {
            box-shadow: none;
        }
    }

    @media (max-width: 576px) {
        .action-buttons button {
            flex: 1 1 calc(50% - 6px);
        }
    }

    @media (max-width: 992px) {
        .col-lg-4 {
            order: 2;
        }
        .col-lg-8 {
            order: 1;
        }
    }
</style>

</head>
<body>
<div class="container-fluid py-3">
  <div class="d-flex justify-content-between align-items-center mb-3">
    <div>
      <h3 class="fw-bold mb-0 text-info">
        <i class="bi bi-calendar3-week me-2"></i>Calendar NLP
      </h3>
      <small class="text-secondary">Nh·∫≠p c√¢u ti·∫øng Vi·ªát ƒë·ªÉ t·∫°o l·ªãch th√¥ng minh</small>
    </div>

    <div class="d-flex flex-wrap gap-2">
  
    <button class="btn btn-outline-light" id="btnImportJson">
      <i class="bi bi-upload me-1"></i>Import JSON
      <input type="file" id="importJsonFile" hidden>
    </button>

    
    <button class="btn btn-outline-info" onclick="window.location='/export/ics'">
        <i class="bi bi-calendar2-week me-1"></i>Xu·∫•t ICS
    </button>
    
    <button class="btn btn-outline-warning" onclick="window.location='/export/json'">
        <i class="bi bi-filetype-json me-1"></i>Xu·∫•t JSON
    </button>
    
    <button id="btnAddEvent" class="btn btn-success">
        <i class="bi bi-plus-circle me-1"></i>Th√™m s·ª± ki·ªán
    </button>
    
    <button id="btnSearchToggle" class="btn btn-outline-light">
        <i class="bi bi-search me-1"></i>T√¨m ki·∫øm
    </button>
    
    <button id="btnSettings" class="btn btn-outline-light">
    <i class="bi bi-gear-fill me-1"></i>C√†i ƒë·∫∑t
    </button>

    </div>

  </div>

  <div class="row g-3">
    <!-- LEFT: CALENDAR -->
    <div class="col-lg-8">
      <div class="calendar-card p-3">
        <div class="d-flex justify-content-between align-items-center calendar-header pb-2 mb-2">
          <div class="btn-group btn-group-sm">
            <button class="btn btn-outline-light" id="btnPrevMonth"><i class="bi bi-chevron-left"></i></button>
            <button class="btn btn-outline-light" id="btnToday">H√¥m nay</button>
            <button class="btn btn-outline-light" id="btnNextMonth"><i class="bi bi-chevron-right"></i></button>
          </div>
          <div class="text-center">
            <h5 class="fw-semibold mb-0" id="lblCurrentMonth"></h5>
            <small class="text-secondary" id="lblCurrentRange"></small>
          </div>
        </div>

        <table class="table table-dark table-borderless mb-2 align-middle">
          <thead>
            <tr class="text-center text-secondary small">
              <th>Th 2</th><th>Th 3</th><th>Th 4</th><th>Th 5</th><th>Th 6</th><th>Th 7</th><th>CN</th>
            </tr>
          </thead>
        </table>
        <div id="calendarGrid" class="calendar-grid"></div>
      </div>
    </div>

    <!-- RIGHT: SIDEBAR -->
      
    <div class="col-lg-4">
          <div class="sidebar-card p-3" id="searchPanel" style="display:none;">
        <h6 class="fw-semibold mb-2">
          <i class="bi bi-search me-1 text-success"></i> T√¨m ki·∫øm s·ª± ki·ªán
        </h6>
        <div class="input-group input-group-sm mb-2">
          <input type="text" id="txtSearch" class="form-control" placeholder="Nh·∫≠p t·ª´ kh√≥a...">
          <button class="btn btn-outline-info" id="btnSearch"><i class="bi bi-search"></i></button>
        </div>
        <div id="searchResultPanel" class="scroll-panel small"></div>
      </div>

      <div class="sidebar-card p-3 mb-3">
        <h6 class="fw-semibold mb-2">
          <i class="bi bi-list-check me-1 text-info"></i> S·ª± ki·ªán trong ng√†y
        </h6>
        <div id="dayEventsPanel" class="scroll-panel small">
          <p class="text-secondary mb-0">Ch·ªçn m·ªôt ng√†y tr√™n l·ªãch ƒë·ªÉ xem chi ti·∫øt s·ª± ki·ªán.</p>
        </div>
      </div>

      <div class="sidebar-card p-3 mb-3">
        <h6 class="fw-semibold mb-2">
          <i class="bi bi-bar-chart-line me-1 text-warning"></i> Th·ªëng k√™ & tu·∫ßn hi·ªán t·∫°i
        </h6>
        <div id="statsPanel" class="scroll-panel small">
          <p class="text-secondary mb-0">Th·ªëng k√™ s·∫Ω hi·ªÉn th·ªã theo th√°ng v√† tu·∫ßn hi·ªán t·∫°i.</p>
        </div>
      </div>
      
    </div>
  </div>
</div>

<!-- Modal: Th√™m/S·ª≠a qua form NLP & edit manual -->
<div class="modal fade" id="eventModal" tabindex="-1">
  <div class="modal-dialog modal-lg modal-dialog-centered">
    <div class="modal-content bg-dark text-light">
      <div class="modal-header border-secondary">
        <h5 class="modal-title" id="eventModalLabel">Th√™m s·ª± ki·ªán m·ªõi</h5>
        <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
      </div>
      <div class="modal-body">
        <!-- NLP input -->
        <div id="eventModalBodyAdd">
          <label class="form-label small text-secondary">Nh·∫≠p c√¢u ti·∫øng Vi·ªát</label>
          <textarea id="txtNatural" class="form-control form-control-sm" rows="3"
            placeholder="VD: Nh·∫Øc t√¥i h·ªçp l·ªõp l√∫c 1 gi·ªù 20 ƒë√™m tu·∫ßn sau th·ª© hai ·ªü ph√≤ng 302, b·∫ø m·∫°c l√∫c 3 r∆∞·ª°i, nh·∫Øc tr∆∞·ªõc 5 ph√∫t"></textarea>
          <small class="text-secondary d-block mt-1">
            H·ªá th·ªëng s·∫Ω ph√¢n t√≠ch c√¢u v√† t·ª± ƒë·ªông t·∫°o s·ª± ki·ªán.
          </small>
        </div>
        <!-- Edit fields -->
        <div id="eventModalBodyEdit" style="display:none;">
          <input type="hidden" id="editEventId">
          <div class="mb-2">
            <label class="form-label small">T√™n s·ª± ki·ªán</label>
            <input type="text" id="editEventTitle" class="form-control form-control-sm">
          </div>
          <div class="mb-2">
            <label class="form-label small">Th·ªùi gian b·∫Øt ƒë·∫ßu</label>
            <input type="datetime-local" id="editEventStart" class="form-control form-control-sm">
          </div>
          <div class="mb-2">
            <label class="form-label small">Th·ªùi gian k·∫øt th√∫c</label>
            <input type="datetime-local" id="editEventEnd" class="form-control form-control-sm">
          </div>
          <div class="mb-2">
            <label class="form-label small">ƒê·ªãa ƒëi·ªÉm</label>
            <input type="text" id="editEventLocation" class="form-control form-control-sm">
          </div>
          <div class="mb-2">
            <label class="form-label small">Nh·∫Øc tr∆∞·ªõc (ph√∫t)</label>
            <input type="number" id="editEventReminder" class="form-control form-control-sm">
          </div>
          <div class="mb-2">
            <label class="form-label small">M√†u s·ª± ki·ªán</label>
            <input type="color" id="editEventColor" class="form-control form-control-color" value="#22c55e">
          </div>
        </div>
      </div>
      <div class="modal-footer border-secondary">
        <button type="button" class="btn btn-outline-secondary btn-sm" data-bs-dismiss="modal">ƒê√≥ng</button>
        <button type="button" class="btn btn-primary btn-sm" id="btnSaveEvent">L∆∞u</button>
      </div>
    </div>
  </div>
</div>

<!-- Modal: Xem chi ti·∫øt event -->
<div class="modal fade" id="eventDetailModal" tabindex="-1">
  <div class="modal-dialog modal-dialog-centered">
    <div class="modal-content bg-dark text-light">
      <div class="modal-header border-secondary">
        <h5 class="modal-title">Chi ti·∫øt s·ª± ki·ªán</h5>
        <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
      </div>
      <div class="modal-body small" id="eventDetailBody">
        <!-- n·ªôi dung fill b·∫±ng JS -->
      </div>
      <div class="modal-footer border-secondary">
        <button type="button" class="btn btn-danger btn-sm" id="btnDetailDelete">
          <i class="bi bi-trash"></i> X√≥a
        </button>
        <button type="button" class="btn btn-info btn-sm" id="btnDetailEdit">
          <i class="bi bi-pencil"></i> S·ª≠a
        </button>
        <button type="button" class="btn btn-outline-secondary btn-sm" data-bs-dismiss="modal">ƒê√≥ng</button>
      </div>
    </div>
  </div>
</div>

<!-- Modal: C√†i ƒê·∫∑t -->
<div class="modal fade" id="settingsModal" tabindex="-1">
  <div class="modal-dialog modal-md modal-dialog-centered">
    <div class="modal-content bg-dark text-light">
      <div class="modal-header border-secondary">
        <h5 class="modal-title"><i class="bi bi-gear-wide-connected me-2"></i>C√†i ƒë·∫∑t h·ªá th·ªëng</h5>
        <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
      </div>

      <div class="modal-body small">
        
        <div class="form-check form-switch mb-3">
          <input class="form-check-input" type="checkbox" id="cfgEnableSound">
          <label class="form-check-label" for="cfgEnableSound">
            Ph√°t √¢m thanh khi nh·∫Øc nh·ªü
          </label>
        </div>

        <div class="mb-3">
          <label class="form-label">Th·ªùi gian l·∫∑p l·∫°i √¢m thanh (gi√¢y)</label>
          <input type="number" id="cfgSoundInterval" class="form-control form-control-sm" min="1" value="5">
        </div>

        <div class="mb-3">
          <label class="form-label">API th√¥ng b√°o qua d·ªãch v·ª• ntfy.sh</label>
          <input type="text" id="cfgNotifyUrl" class="form-control form-control-sm"
            placeholder="https://example.com/push">
        </div>

      </div>

      <div class="modal-footer border-secondary">
        <button type="button" class="btn btn-outline-secondary btn-sm" data-bs-dismiss="modal">ƒê√≥ng</button>
        <button type="button" class="btn btn-primary btn-sm" id="btnSaveSettings">
          <i class="bi bi-save me-1"></i>L∆∞u c√†i ƒë·∫∑t
        </button>
      </div>
    </div>
  </div>
</div>


<div class="toast-container" id="toastContainer"></div>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>

<audio id="notifSound" preload="auto">
  <source src="https://actions.google.com/sounds/v1/alarms/beep_short.ogg" type="audio/ogg">
</audio>

<script>
  let currentYear = {{ current_year }};
  let currentMonth = {{ current_month }};
  let eventsInMonth = [];
  let selectedDate = null; // yyyy-mm-dd
  let eventModal = null;
  let eventDetailModal = null;
  let notifiedEvents = new Set();
  let currentView = "month"; // month / week / day

  document.addEventListener("DOMContentLoaded", () => {
    eventModal = new bootstrap.Modal(document.getElementById("eventModal"));
    eventDetailModal = new bootstrap.Modal(document.getElementById("eventDetailModal"));

    document.getElementById("btnPrevMonth").addEventListener("click", () => changeMonth(-1));
    document.getElementById("btnNextMonth").addEventListener("click", () => changeMonth(1));
    document.getElementById("btnToday").addEventListener("click", () => goToday());

    document.getElementById("btnAddEvent").addEventListener("click", openAddEventModal);
    document.getElementById("btnSaveEvent").addEventListener("click", onSaveEvent);

    document.getElementById("btnSearchToggle").addEventListener("click", () => {
      const pnl = document.getElementById("searchPanel");
      pnl.style.display = (pnl.style.display === "none" || pnl.style.display === "") ? "block" : "none";
    });
    document.getElementById("btnSearch").addEventListener("click", doSearch);

    document.getElementById("btnDetailDelete").addEventListener("click", onDetailDelete);
    document.getElementById("btnDetailEdit").addEventListener("click", onDetailEdit);

    loadEventsForCurrentMonth();

    // Reminder check: m·ªói 60s
    setInterval(checkReminders, 10000);
    checkReminders();
  });

  // ============== LOAD SETTING ===============
let appSettings = {
    enable_sound: true,
    sound_interval: 5,
    notify_url: ""
};

let settingsModal = null;

document.addEventListener("DOMContentLoaded", () => {
    settingsModal = new bootstrap.Modal(document.getElementById("settingsModal"));

    document.getElementById("btnSettings").addEventListener("click", openSettingsModal);
    document.getElementById("btnSaveSettings").addEventListener("click", saveSettings);

    // load l√∫c kh·ªüi ƒë·ªông
    loadSettingsFromServer();
});

function loadSettingsFromServer() {
    fetch("/api/settings")
        .then(r => r.json())
        .then(cfg => {
            // Cache
            appSettings = cfg;

            // ƒêi·ªÅn v√†o UI
            document.getElementById("cfgEnableSound").checked = cfg.enable_sound ?? true;
            document.getElementById("cfgSoundInterval").value = cfg.sound_interval ?? 5;
            document.getElementById("cfgNotifyUrl").value = cfg.notify_url ?? "";
        })
        .catch(err => console.error("[SETTINGS] Load failed:", err));
}

function openSettingsModal() {
    // refresh UI m·ªói l·∫ßn m·ªü modal
    document.getElementById("cfgEnableSound").checked = appSettings.enable_sound ?? true;
    document.getElementById("cfgSoundInterval").value = appSettings.sound_interval ?? 5;
    document.getElementById("cfgNotifyUrl").value = appSettings.notify_url ?? "";

    settingsModal.show();
}

function saveSettings() {
    const payload = {
        enable_sound: document.getElementById("cfgEnableSound").checked,
        sound_interval: parseInt(document.getElementById("cfgSoundInterval").value || "5", 10),
        notify_url: document.getElementById("cfgNotifyUrl").value.trim()
    };

    fetch("/api/settings", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify(payload)
    })
        .then(r => r.json())
        .then(res => {
            if (res.status === "ok") {
                appSettings = payload; // update local cache
                alert("ƒê√£ l∆∞u c√†i ƒë·∫∑t!");
                settingsModal.hide();
            } else {
                alert("Kh√¥ng th·ªÉ l∆∞u c√†i ƒë·∫∑t.");
            }
        })
        .catch(err => console.error("[SETTINGS] Save failed:", err));
}


  // =============== LOAD EVENTS ===============
  function loadEventsForCurrentMonth() {
    fetch(`/api/events?year=${currentYear}&month=${currentMonth}`)
      .then(r => r.json())
      .then(data => {
        eventsInMonth = data.events || [];
        renderCalendar();
        renderStats(data.stats);
      })
      .catch(console.error);
  }

  function renderCalendar() {
    const lblMonth = document.getElementById("lblCurrentMonth");
    const lblRange = document.getElementById("lblCurrentRange");
    const grid = document.getElementById("calendarGrid");
    grid.innerHTML = "";

    const monthNames = ["Th√°ng 1","Th√°ng 2","Th√°ng 3","Th√°ng 4","Th√°ng 5","Th√°ng 6",
      "Th√°ng 7","Th√°ng 8","Th√°ng 9","Th√°ng 10","Th√°ng 11","Th√°ng 12"];
    lblMonth.textContent = `${monthNames[currentMonth-1]} ${currentYear}`;

    const firstDay = new Date(currentYear, currentMonth-1, 1);
    let firstWeekday = firstDay.getDay(); 
    if (firstWeekday === 0) firstWeekday = 6; else firstWeekday -= 1;
    const daysInMonth = new Date(currentYear, currentMonth, 0).getDate();
    const today = new Date();
    const todayStr = today.toISOString().slice(0,10);

    const startDateStr = new Date(currentYear, currentMonth-1, 1).toISOString().slice(0,10);
    const endDateStr = new Date(currentYear, currentMonth-1, daysInMonth).toISOString().slice(0,10);
    lblRange.textContent = `${startDateStr} ‚Üí ${endDateStr}`;

    // Month view: render full 6 weeks
    let cells = [];
    for (let i=0;i<firstWeekday;i++) cells.push(0);
    for (let d=1; d<=daysInMonth; d++) cells.push(d);
    while (cells.length < 42) cells.push(0);

    cells.forEach(d => {
      if (d === 0) {
        let cell = document.createElement("div");
        cell.className = "day-cell";
        grid.appendChild(cell);
      } else {
        const dateObj = new Date(currentYear, currentMonth-1, d);
        const dateStr = dateObj.getFullYear() + "-" +
                String(dateObj.getMonth()+1).padStart(2,"0") + "-" +
                String(dateObj.getDate()).padStart(2,"0");
        const cellEvents = eventsInMonth.filter(ev => ev.date_str === dateStr);

        let cell = document.createElement("div");
        cell.className = "day-cell";
        cell.dataset.date = dateStr;
        if (dateStr === todayStr) cell.classList.add("day-today");

        let header = document.createElement("div");
        header.className = "d-flex justify-content-between align-items-center";
        header.innerHTML = `<span class="day-number">${d}</span>` +
          (cellEvents.length>0 ? `<span class="badge bg-primary-subtle text-primary border-0 small">${cellEvents.length}</span>` : "");
        cell.appendChild(header);

        let wrap = document.createElement("div");
        wrap.className = "day-events";
        cellEvents.forEach(ev => {
          let span = document.createElement("span");
          span.className = "event-pill";
          span.style.background = ev.color || "#22c55e";
          span.title = `${ev.time_str || ""} ${ev.event}`;
          span.textContent = `${ev.time_str || ""} ${ev.event}`;
          span.onclick = (e) => { e.stopPropagation(); openEventDetail(ev.id); };
          wrap.appendChild(span);
        });
        cell.appendChild(wrap);

        cell.onclick = () => onDayClick(dateStr);
        grid.appendChild(cell);
      }
    });

    // Default selected date
    if (!selectedDate) {
      selectedDate = todayStr;
    }
    onDayClick(selectedDate, false); // update side panels
  }

  function onDayClick(dateStr, focus=true) {
    selectedDate = dateStr;
    const events = eventsInMonth.filter(ev => ev.date_str === dateStr);
    const panel = document.getElementById("dayEventsPanel");
    if (events.length === 0) {
      panel.innerHTML = `<p class="text-secondary mb-0">Kh√¥ng c√≥ s·ª± ki·ªán n√†o trong ng√†y ${dateStr}.</p>`;
      return;
    }
    let html = "";
    events.forEach(ev => {
      html += `
        <div class="card bg-transparent border border-secondary mb-2">
          <div class="card-body p-2">
            <div class="d-flex justify-content-between align-items-center">
              <div>
                <div class="fw-semibold">${ev.event || "(Kh√¥ng t√™n)"}</div>
                <div class="small text-secondary">
                  <i class="bi bi-clock me-1"></i>${ev.time_str || ""} 
                  ${ev.end_time ? "‚Üí " + ev.end_time.split("T")[1].slice(0,5) : ""}
                </div>
                <div class="small text-secondary">
                  <i class="bi bi-geo-alt me-1"></i>${ev.location || "Kh√¥ng r√µ ƒë·ªãa ƒëi·ªÉm"}
                </div>
                <div class="small text-secondary">
                  <i class="bi bi-bell me-1"></i>Nh·∫Øc tr∆∞·ªõc: ${ev.reminder_minutes || 0} ph√∫t
                </div>
              </div>
              <div class="btn-group btn-group-sm">
                <button class="btn btn-outline-info" onclick="openEditEvent(${ev.id})">
                  <i class="bi bi-pencil"></i>
                </button>
                <button class="btn btn-outline-danger" onclick="deleteEvent(${ev.id})">
                  <i class="bi bi-trash"></i>
                </button>
              </div>
            </div>
          </div>
        </div>`;
    });
    panel.innerHTML = html;
    if (focus) setView("day");
  }

  // =============== STATS (month + week) ===============
  function renderStats(stats) {
    const panel = document.getElementById("statsPanel");
    if (!stats) {
      panel.innerHTML = `<p class="text-secondary mb-0">Kh√¥ng c√≥ th·ªëng k√™.</p>`;
      return;
    }
    // tu·∫ßn hi·ªán t·∫°i d·ª±a tr√™n selectedDate
    let sd = selectedDate ? new Date(selectedDate) : new Date();
    let isoYear = sd.getFullYear();
    let isoWeek = getISOWeek(sd);

    let html = "";
    html += `<div class="mb-1 small">T·ªïng s·ª± ki·ªán trong th√°ng: <strong>${stats.total_events}</strong></div>`;

    html += `<div class="mb-1 small fw-semibold">Theo ng√†y trong th√°ng:</div><ul class="small">`;
    for (const [day, count] of Object.entries(stats.by_day || {})) {
      html += `<li>${day}: <strong>${count}</strong> s·ª± ki·ªán</li>`;
    }
    html += `</ul>`;

    html += `<div class="mb-1 small fw-semibold">Theo tu·∫ßn (ISO):</div><ul class="small">`;
    for (const [week, count] of Object.entries(stats.by_week || {})) {
      const highlight = (week === `${isoYear}-W${String(isoWeek).padStart(2,"0")}`) ? ' class="text-info fw-semibold"' : "";
      html += `<li${highlight}>${week}: <strong>${count}</strong> s·ª± ki·ªán</li>`;
    }
    html += `</ul>`;

    // T·ªïng h·ª£p s·ª± ki·ªán trong tu·∫ßn hi·ªán t·∫°i
    const weekKey = `${isoYear}-W${String(isoWeek).padStart(2,"0")}`;
    const weekEvents = eventsInMonth.filter(ev => {
      if (!ev.start_time) return false;
      const d = new Date(ev.start_time);
      return `${d.getFullYear()}-W${String(getISOWeek(d)).padStart(2,"0")}` === weekKey;
    });
    html += `<div class="mb-1 small fw-semibold">S·ª± ki·ªán trong tu·∫ßn hi·ªán t·∫°i (${weekKey}):</div>`;
    if (weekEvents.length === 0) {
      html += `<p class="text-secondary small mb-0">Kh√¥ng c√≥ s·ª± ki·ªán n√†o trong tu·∫ßn.</p>`;
    } else {
      html += `<ul class="small">`;
      weekEvents.forEach(ev => {
        html += `<li>${ev.date_str} ${ev.time_str || ""} - ${ev.event}</li>`;
      });
      html += `</ul>`;
    }

    panel.innerHTML = html;
  }

  function getISOWeek(d) {
    d = new Date(Date.UTC(d.getFullYear(), d.getMonth(), d.getDate()));
    const dayNum = d.getUTCDay() || 7;
    d.setUTCDate(d.getUTCDate() + 4 - dayNum);
    const yearStart = new Date(Date.UTC(d.getUTCFullYear(),0,1));
    return Math.ceil((((d - yearStart) / 86400000) + 1)/7);
  }

  // =============== MONTH NAVIGATION ===============
  function changeMonth(delta) {
    currentMonth += delta;
    if (currentMonth < 1) { currentMonth = 12; currentYear--; }
    if (currentMonth > 12) { currentMonth = 1; currentYear++; }
    loadEventsForCurrentMonth();
  }
  function goToday() {
    const today = new Date();
    currentYear = today.getFullYear();
    currentMonth = today.getMonth() + 1;
    selectedDate = today.toISOString().slice(0,10);
    loadEventsForCurrentMonth();
  }

  // =============== ADD / EDIT / DELETE ===============
  function openAddEventModal() {
    document.getElementById("eventModalLabel").textContent = "Th√™m s·ª± ki·ªán m·ªõi (NLP)";
    document.getElementById("eventModalBodyAdd").style.display = "block";
    document.getElementById("eventModalBodyEdit").style.display = "none";
    document.getElementById("txtNatural").value = "";
    document.getElementById("btnSaveEvent").dataset.mode = "add";
    eventModal.show();
  }

function formatForInput(dt) {
    if (!dt) return "";
    const d = new Date(dt);  // dt l√† ISO c√≥ timezone GMT+7
    const pad = x => String(x).padStart(2,"0");
    return `${d.getFullYear()}-${pad(d.getMonth()+1)}-${pad(d.getDate())}T${pad(d.getHours())}:${pad(d.getMinutes())}`;
}

  function openEditEvent(id) {
    fetch(`/api/events/${id}`)
      .then(r => r.json())
      .then(ev => {
        document.getElementById("eventModalLabel").textContent = "S·ª≠a s·ª± ki·ªán";
        document.getElementById("eventModalBodyAdd").style.display = "none";
        document.getElementById("eventModalBodyEdit").style.display = "block";

        document.getElementById("editEventId").value = ev.id;
        document.getElementById("editEventTitle").value = ev.event || "";
        document.getElementById("editEventStart").value = formatForInput(ev.start_time) || "";
        document.getElementById("editEventEnd").value = formatForInput(ev.end_time) || "";
        document.getElementById("editEventLocation").value = ev.location || "";
        document.getElementById("editEventReminder").value = ev.reminder_minutes || 0;
        document.getElementById("editEventColor").value = ev.color || "#22c55e";

        document.getElementById("btnSaveEvent").dataset.mode = "edit";
        eventModal.show();
      });
  }

  function onSaveEvent() {
    const mode = document.getElementById("btnSaveEvent").dataset.mode;
    if (mode === "add") {
      const text = document.getElementById("txtNatural").value.trim();
      if (!text) { alert("Vui l√≤ng nh·∫≠p c√¢u ti·∫øng Vi·ªát."); return; }
      fetch("/api/events", {
        method: "POST",
        headers: {"Content-Type":"application/json"},
        body: JSON.stringify({ natural_text: text })
      }).then(r=>r.json()).then(res=>{
        if (res.status==="ok") {
          eventModal.hide();
          loadEventsForCurrentMonth();
        } else {
          alert("Kh√¥ng th·ªÉ t·∫°o s·ª± ki·ªán.");
        }
      });
    } else {
      const id = document.getElementById("editEventId").value;
      const payload = {
        event: document.getElementById("editEventTitle").value,
        start_time: document.getElementById("editEventStart").value || null,
        end_time: document.getElementById("editEventEnd").value || null,
        location: document.getElementById("editEventLocation").value,
        reminder_minutes: parseInt(document.getElementById("editEventReminder").value || "0",10),
        color: document.getElementById("editEventColor").value || "#22c55e"
      };
      fetch(`/api/events/${id}`, {
        method: "PUT",
        headers: {"Content-Type":"application/json"},
        body: JSON.stringify(payload)
      }).then(r=>r.json()).then(res=>{
        if (res.status==="ok") {
          eventModal.hide();
          loadEventsForCurrentMonth();
        } else {
          alert("Kh√¥ng th·ªÉ c·∫≠p nh·∫≠t s·ª± ki·ªán.");
        }
      });
    }
  }

  function deleteEvent(id) {
    if (!confirm("B·∫°n c√≥ ch·∫Øc ch·∫Øn mu·ªën x√≥a s·ª± ki·ªán n√†y?")) return;
    fetch(`/api/events/${id}`, { method:"DELETE" })
      .then(r=>r.json()).then(res=>{
        if (res.status==="ok") {
          loadEventsForCurrentMonth();
        }
      });
  }

  // =============== DETAIL MODAL ===============
  let detailEventId = null;
  function openEventDetail(id) {
    fetch(`/api/events/${id}`)
      .then(r=>r.json())
      .then(ev=>{
        detailEventId = ev.id;
        const body = document.getElementById("eventDetailBody");
        const start = ev.start_time ? ev.start_time.replace("T"," ") : "(kh√¥ng c√≥)";
        const end = ev.end_time ? ev.end_time.replace("T"," ") : "(kh√¥ng c√≥)";
        body.innerHTML = `
          <div class="mb-1"><strong>${ev.event || "(Kh√¥ng t√™n)"}</strong></div>
          <div class="small text-secondary mb-1">
            <i class="bi bi-calendar-event me-1"></i>${ev.date_str || ""} 
            <i class="bi bi-clock ms-2 me-1"></i>${ev.time_str || ""}</div>
          <div class="small mb-1"><strong>B·∫Øt ƒë·∫ßu:</strong> ${start}</div>
          <div class="small mb-1"><strong>K·∫øt th√∫c:</strong> ${end}</div>
          <div class="small mb-1">
            <strong>ƒê·ªãa ƒëi·ªÉm:</strong> ${ev.location || "Kh√¥ng r√µ"}</div>
          <div class="small mb-1">
            <strong>Nh·∫Øc tr∆∞·ªõc:</strong> ${ev.reminder_minutes || 0} ph√∫t</div>
          <div class="small mb-1 d-flex align-items-center">
            <strong class="me-2">M√†u:</strong>
            <span style="width:16px;height:16px;border-radius:999px;background:${ev.color || "#22c55e"};display:inline-block;"></span>
          </div>`;
        eventDetailModal.show();
      });
  }

  function onDetailDelete() {
    if (!detailEventId) return;
    if (!confirm("X√≥a s·ª± ki·ªán n√†y?")) return;
    deleteEvent(detailEventId);
    eventDetailModal.hide();
  }

  function onDetailEdit() {
    if (!detailEventId) return;
    eventDetailModal.hide();
    openEditEvent(detailEventId);
  }

  // =============== SEARCH ===============
  function doSearch() {
    const q = document.getElementById("txtSearch").value.trim();
    if (!q) {
      document.getElementById("searchResultPanel").innerHTML =
        `<p class="text-secondary mb-0">Nh·∫≠p t·ª´ kh√≥a ƒë·ªÉ t√¨m.</p>`;
      return;
    }
    fetch(`/api/search?q=${encodeURIComponent(q)}`)
      .then(r=>r.json()).then(data=>{
        const events = data.events || [];
        const panel = document.getElementById("searchResultPanel");
        if (events.length === 0) {
          panel.innerHTML = `<p class="text-secondary mb-0">Kh√¥ng t√¨m th·∫•y s·ª± ki·ªán n√†o.</p>`;
          return;
        }
        let html = "";
        events.forEach(ev=>{
          html += `
            <div class="card bg-transparent border border-secondary mb-2">
              <div class="card-body p-2 small">
                <div class="fw-semibold">${ev.event || "(Kh√¥ng t√™n)"}</div>
                <div class="text-secondary">
                  <i class="bi bi-calendar-event me-1"></i>${(ev.start_time||"").split("T")[0] || ""} 
                  <i class="bi bi-clock ms-2 me-1"></i>${(ev.start_time||"").split("T")[1]?.slice(0,5) || ""}
                </div>
                <div class="text-secondary"><i class="bi bi-geo-alt me-1"></i>${ev.location || "Kh√¥ng r√µ"}</div>
                <div class="mt-1">
                  <button class="btn btn-outline-info btn-sm" onclick="openEditEvent(${ev.id})">
                    <i class="bi bi-pencil"></i> S·ª≠a
                  </button>
                  <button class="btn btn-outline-danger btn-sm" onclick="deleteEvent(${ev.id})">
                    <i class="bi bi-trash"></i> X√≥a
                  </button>
                </div>
              </div>
            </div>`;
        });
        panel.innerHTML = html;
      });
  }

  // =============== REMINDERS (POPUP) ===============
  function checkReminders() {
    fetch("/api/reminders")
      .then(r=>r.json())
      .then(data=>{
        (data.events || []).forEach(ev=>{
          const key = ev.id + "|" + (ev.start_time || "");
          if (notifiedEvents.has(key)) return;
          notifiedEvents.add(key);
          showReminderToast(ev);
          sendReminderToPhone(ev);
        });
      })
      .catch(console.error);
  }

// =============== SEND REMINDER TO PHONE ===============
function encodeRFC2047(text) {
  const utf8Bytes = new TextEncoder().encode(text);
  const base64 = btoa(String.fromCharCode(...utf8Bytes));
  return `=?UTF-8?B?${base64}?=`;
}

function sendReminderToPhone(ev) {
    if (!appSettings.notify_url || appSettings.notify_url.trim() === "") {
        console.warn("[NOTIFY] No notify_url configured, skip push.");
        return;
    }

    const topic = appSettings.notify_url.replace(/^https?:\/\//, "").trim();  
    // v√≠ d·ª• topic = "ntfy.sh/nlpnotify_server_demo123"

    const apiUrl = `https://${topic}`;
    const title = `Ch√∫ √Ω: ${ev.event}`;
    const body  = `${ev.event} - ${ev.time_str} - ${ev.location || "Kh√¥ng r√µ ƒë·ªãa ƒëi·ªÉm"}`;

    fetch(apiUrl, {
        method: "POST",
        headers: {
            "Title": encodeRFC2047(title),
            "Priority": "high",
            "Tags": "alarm_clock",
            "Content-Type": "text/plain"
        },
        body: body
    })
    .then(() => console.log("[NOTIFY] Sent to phone:", apiUrl))
    .catch(err => console.error("[NOTIFY] Error:", err));
}

function showReminderToast(ev) {
  const container = document.getElementById("toastContainer");
  const id = "toast_"+ev.id+"_"+Date.now();

  const html = `
    <div id="${id}" class="toast mb-2" role="alert" aria-live="assertive" aria-atomic="true">
      <div class="d-flex">
        <div class="toast-body small">
          <div class="fw-semibold mb-1">
            <span class="badge-dot" style="background:#facc15;"></span>
            üîî S·∫Øp ƒë·∫øn gi·ªù: ${ev.event || "(Kh√¥ng t√™n)"}
          </div>
          <div class="text-secondary">
            <i class="bi bi-clock me-1"></i>${ev.time_str || ""}
            <span class="ms-2"><i class="bi bi-geo-alt me-1"></i>${ev.location || "Kh√¥ng r√µ ƒë·ªãa ƒëi·ªÉm"}</span>
          </div>
        </div>
        <button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast"></button>
      </div>
    </div>`;

  container.insertAdjacentHTML("beforeend", html);

  const toastEl = document.getElementById(id);
  const toast = new bootstrap.Toast(toastEl, { autohide: false });

  // L·∫•y setting
  const enableSound = appSettings.enable_sound ?? true;
  const soundInterval = parseInt(appSettings.sound_interval || "5", 10);
  const notifyUrl = appSettings.notify_url || "";

  // √Çm thanh
  const audioEl = document.getElementById("notifSound");

  function playSound() {
    if (!enableSound) return;

    try {
      audioEl.currentTime = 0;
      audioEl.play().catch(()=>{});
    } catch (e) {
      console.warn("Cannot play sound:", e);
    }
  }

  // 1) Ph√°t ti·∫øng l·∫ßn ƒë·∫ßu
  playSound();

  // 2) L·∫∑p √¢m thanh d·ª±a tr√™n c√†i ƒë·∫∑t
  let intervalId = null;
  if (enableSound && soundInterval > 0) {
    intervalId = setInterval(playSound, soundInterval * 1000);
  }

  // 3) Khi toast ƒë√≥ng ‚Üí stop sound loop
  toastEl.addEventListener("hidden.bs.toast", () => {
    if (intervalId) clearInterval(intervalId);
  });


  toast.show();
}

document.getElementById("btnImportJson").addEventListener("click", () => {
    document.getElementById("importJsonFile").click();
});

document.getElementById("importJsonFile").addEventListener("change", function () {
    const file = this.files[0];
    if (!file) return;

    const form = new FormData();
    form.append("file", file);

    fetch("/import/json", {
        method: "POST",
        body: form
    })
    .then(r => r.json())
    .then(res => {
        if (res.status === "ok") {
            alert("Import th√†nh c√¥ng " + res.imported + " s·ª± ki·ªán!");
            loadEventsForCurrentMonth();
        } else {
            alert(res.message);
        }
    });
});


</script>
</body>
</html>